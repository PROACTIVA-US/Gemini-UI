{
  "name": "veria-secret-rotation",
  "description": "Automated secret rotation across all Veria infrastructure services",
  "version": "1.0.0",
  "services": [
    {
      "name": "stripe",
      "displayName": "Stripe API Keys",
      "url": "https://dashboard.stripe.com/test/apikeys",
      "loginRequired": true,
      "flow": ["login", "navigate", "rotate_secret_key", "capture_secret", "rotate_webhook", "capture_webhook"],
      "tasks": {
        "rotate_secret_key": {
          "description": "Click 'Create secret key' button",
          "expect": "New secret key modal visible",
          "timeout": 15000,
          "selector": "button:has-text('Create secret key')"
        },
        "capture_secret": {
          "description": "Copy secret key from modal before it's hidden",
          "expect": "Secret key copied",
          "timeout": 10000,
          "outputVar": "STRIPE_SECRET_KEY"
        },
        "rotate_webhook": {
          "description": "Navigate to webhooks and roll signing secret",
          "expect": "Webhook secret rotated",
          "timeout": 15000,
          "url": "https://dashboard.stripe.com/test/webhooks"
        },
        "capture_webhook": {
          "description": "Copy new webhook signing secret",
          "expect": "Webhook secret copied",
          "timeout": 10000,
          "outputVar": "STRIPE_WEBHOOK_SECRET"
        }
      },
      "outputs": ["STRIPE_SECRET_KEY", "STRIPE_WEBHOOK_SECRET"]
    },
    {
      "name": "resend",
      "displayName": "Resend API Key",
      "url": "https://resend.com/api-keys",
      "loginRequired": true,
      "flow": ["login", "navigate", "create_key", "capture_key", "delete_old"],
      "tasks": {
        "create_key": {
          "description": "Click 'Create API Key' button",
          "expect": "New API key modal visible",
          "timeout": 10000,
          "selector": "button:has-text('Create API Key')"
        },
        "capture_key": {
          "description": "Copy new API key from modal",
          "expect": "API key copied",
          "timeout": 10000,
          "outputVar": "RESEND_API_KEY"
        },
        "delete_old": {
          "description": "Delete previous API key",
          "expect": "Old key deleted",
          "timeout": 10000,
          "optional": true
        }
      },
      "outputs": ["RESEND_API_KEY"]
    },
    {
      "name": "github-oauth",
      "displayName": "GitHub OAuth Credentials",
      "url": "https://github.com/settings/developers",
      "loginRequired": true,
      "flow": ["login", "navigate", "find_app", "generate_secret", "capture_secret"],
      "tasks": {
        "find_app": {
          "description": "Locate Veria OAuth App in list",
          "expect": "OAuth app found",
          "timeout": 10000,
          "searchText": "veria"
        },
        "generate_secret": {
          "description": "Click 'Generate a new client secret'",
          "expect": "New secret generated",
          "timeout": 15000,
          "selector": "button:has-text('Generate a new client secret')"
        },
        "capture_secret": {
          "description": "Copy new client secret",
          "expect": "Secret copied",
          "timeout": 10000,
          "outputVar": "GITHUB_CLIENT_SECRET"
        }
      },
      "outputs": ["GITHUB_CLIENT_SECRET"]
    },
    {
      "name": "google-oauth",
      "displayName": "Google OAuth Credentials",
      "url": "https://console.cloud.google.com/apis/credentials",
      "loginRequired": true,
      "flow": ["login", "navigate", "find_client", "reset_secret", "capture_secret"],
      "tasks": {
        "find_client": {
          "description": "Locate Veria OAuth 2.0 Client ID",
          "expect": "OAuth client found",
          "timeout": 15000,
          "searchText": "veria"
        },
        "reset_secret": {
          "description": "Reset client secret",
          "expect": "New secret generated",
          "timeout": 15000,
          "selector": "button:has-text('Reset secret')"
        },
        "capture_secret": {
          "description": "Copy new client secret",
          "expect": "Secret copied",
          "timeout": 10000,
          "outputVar": "GOOGLE_CLIENT_SECRET"
        }
      },
      "outputs": ["GOOGLE_CLIENT_SECRET"]
    },
    {
      "name": "supabase",
      "displayName": "Supabase Database Password",
      "url": "https://supabase.com/dashboard/project/_/settings/database",
      "loginRequired": true,
      "flow": ["login", "navigate", "reset_password", "capture_password"],
      "tasks": {
        "reset_password": {
          "description": "Click 'Reset database password'",
          "expect": "Password reset dialog visible",
          "timeout": 15000,
          "selector": "button:has-text('Reset database password')"
        },
        "capture_password": {
          "description": "Copy new database password",
          "expect": "Password copied",
          "timeout": 10000,
          "outputVar": "DATABASE_PASSWORD"
        }
      },
      "outputs": ["DATABASE_PASSWORD"]
    },
    {
      "name": "local-secrets",
      "displayName": "Locally Generated Secrets",
      "url": null,
      "loginRequired": false,
      "flow": ["generate_nextauth", "generate_compliance_key"],
      "tasks": {
        "generate_nextauth": {
          "description": "Generate NEXTAUTH_SECRET using openssl",
          "command": "openssl rand -base64 32",
          "outputVar": "NEXTAUTH_SECRET"
        },
        "generate_compliance_key": {
          "description": "Generate COMPLIANCE_API_ADMIN_KEY using openssl",
          "command": "openssl rand -hex 32",
          "outputVar": "COMPLIANCE_API_ADMIN_KEY"
        }
      },
      "outputs": ["NEXTAUTH_SECRET", "COMPLIANCE_API_ADMIN_KEY"]
    },
    {
      "name": "vercel",
      "displayName": "Vercel Environment Variables",
      "url": "https://vercel.com/proactiva-us/veria-website/settings/environment-variables",
      "loginRequired": true,
      "flow": ["login", "navigate", "update_secrets"],
      "tasks": {
        "update_secrets": {
          "description": "Update all rotated environment variables",
          "expect": "All secrets updated in Vercel",
          "timeout": 30000,
          "method": "api"
        }
      },
      "outputs": [],
      "inputs": [
        "NEXTAUTH_SECRET",
        "STRIPE_SECRET_KEY",
        "STRIPE_WEBHOOK_SECRET",
        "RESEND_API_KEY",
        "GITHUB_CLIENT_SECRET",
        "GOOGLE_CLIENT_SECRET",
        "DATABASE_PASSWORD",
        "COMPLIANCE_API_ADMIN_KEY"
      ]
    }
  ],
  "states": {
    "login": {
      "expect": "Login successful, dashboard visible",
      "timeout": 20000
    },
    "navigate": {
      "expect": "Target page loaded",
      "timeout": 15000
    },
    "rotate": {
      "expect": "New secret generated",
      "timeout": 20000
    },
    "capture": {
      "expect": "Secret captured and stored",
      "timeout": 10000
    },
    "verify": {
      "expect": "Secret rotation verified",
      "timeout": 15000
    }
  },
  "executionOrder": [
    "local-secrets",
    "stripe",
    "resend",
    "github-oauth",
    "google-oauth",
    "supabase",
    "vercel"
  ],
  "rollbackStrategy": {
    "enabled": true,
    "keepOldSecrets": true,
    "verifyBeforeCommit": true,
    "testEndpoints": [
      "https://veria.cc/api/auth/signin",
      "https://veria.cc/api/test-connection"
    ]
  },
  "maxRetries": 2,
  "defaultTimeout": 30000,
  "screenshotOnError": true
}
